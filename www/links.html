<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>links - go2rtc</title>
    <style>
        div > li {
            list-style-type: none;
            padding-left: 10px;
            position: relative;
        }

        div > li:before {
            content: "-";
            position: absolute;
            left: 0;
        }
    </style>
</head>
<body>

<script src="main.js"></script>

<main>
    <div id="links"></div>
    <script>
        const src = new URLSearchParams(location.search).get('src').replace(/[<">]/g, ''); // sanitize

        const links = document.getElementById('links');

        links.innerHTML = `
        <h2>Any codec in source</h2>
        <li><a href="stream.html?src=${src}">stream.html</a> with auto-select mode / browsers: all / codecs: H264, H265*, MJPEG, JPEG, AAC, PCMU, PCMA, OPUS</li>
        <li><a href="api/streams?src=${src}">info.json</a> page with active connections</li>
    `;

        const url = new URL('api', location.href);
        fetch(url, {cache: 'no-cache'}).then(r => r.json()).then(data => {
            let rtsp = location.host + ':8554';
            try {
                const host = data.host.match(/^[^:]+/)[0];
                const port = data.rtsp.listen.match(/[0-9]+$/)[0];
                rtsp = `${host}:${port}`;
            } catch (e) {
            }

            links.innerHTML += `
            <li><a href="rtsp://${rtsp}/${src}">rtsp</a> with only one video and one audio / codecs: any</li>
            <li><a href="rtsp://${rtsp}/${src}?mp4">rtsp</a> for MP4 recording (Hass or Frigate) / codecs: H264, H265, AAC</li>
            <li><a href="rtsp://${rtsp}/${src}?video=all&audio=all">rtsp</a> with all tracks / codecs: any</li>

            <pre>ffplay -fflags nobuffer -flags low_delay -rtsp_transport tcp "rtsp://${rtsp}/${src}"</pre>

            <h2>H264/H265 source</h2>
            <li><a href="stream.html?src=${src}&mode=webrtc">stream.html</a> WebRTC stream / browsers: all / codecs: H264, PCMU, PCMA, OPUS / +H265 in Safari</li>
            <li><a href="stream.html?src=${src}&mode=mse">stream.html</a> MSE stream / browsers: Chrome, Firefox, Safari Mac/iPad / codecs: H264, H265*, AAC, PCMA*, PCMU*, PCM* / +OPUS in Chrome and Firefox</li>
            <li><a href="api/stream.mp4?src=${src}">stream.mp4</a> legacy MP4 stream with AAC audio / browsers: Chrome, Firefox / codecs: H264, H265*, AAC</li>
            <li><a href="api/stream.mp4?src=${src}&mp4=flac">stream.mp4</a> modern MP4 stream with common audio / browsers: Chrome, Firefox / codecs: H264, H265*, AAC, FLAC (PCMA, PCMU, PCM)</li>
            <li><a href="api/stream.mp4?src=${src}&mp4=all">stream.mp4</a> MP4 stream with any audio / browsers: Chrome / codecs: H264, H265*, AAC, OPUS, MP3, FLAC (PCMA, PCMU, PCM)</li>
            <li><a href="api/frame.mp4?src=${src}">frame.mp4</a> snapshot in MP4-format / browsers: all / codecs: H264, H265*</li>
            <li><a href="api/stream.m3u8?src=${src}">stream.m3u8</a> legacy HLS/TS / browsers: Safari all, Chrome Android / codecs: H264</li>
            <li><a href="api/stream.m3u8?src=${src}&mp4">stream.m3u8</a> legacy HLS/fMP4 / browsers: Safari all, Chrome Android / codecs: H264, H265*, AAC</li>
            <li><a href="api/stream.m3u8?src=${src}&mp4=flac">stream.m3u8</a> modern HLS/fMP4 / browsers: Safari all, Chrome Android / codecs: H264, H265*, AAC, FLAC (PCMA, PCMU, PCM)</li>

            <h2>MJPEG source</h2>
            <li><a href="stream.html?src=${src}&mode=mjpeg">stream.html</a> with MJPEG mode / browsers: all / codecs: MJPEG, JPEG</li>
            <li><a href="api/stream.mjpeg?src=${src}">stream.mjpeg</a> MJPEG stream / browsers: all / codecs: MJPEG, JPEG</li>
            <li><a href="api/frame.jpeg?src=${src}">frame.jpeg</a> snapshot in JPEG-format / browsers: all / codecs: MJPEG, JPEG</li>
        `;
        });
    </script>

    <div id="homekit" style="display: none">
        <h2>HomeKit server</h2>
    </div>
    <script>
        fetch(`api/homekit?id=${src}`, {cache: 'no-cache'}).then(async (r) => {
            if (!r.ok) return;

            const div = document.querySelector('#homekit');
            div.innerHTML += `<div><a href="${r.url}">info.json</a> page with active connections</div>`;
            div.style = '';

            /** @type {{name: string, category_id: string, setup_code: string, setup_id: string, setup_uri: string}} */
            const data = await r.json();
            if (data.setup_code === undefined) return;

            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js';
            script.async = true;
            script.onload = () => {
                /* global BigInt */
                const categoryID = BigInt(data.category_id);
                const pin = BigInt(data.setup_code.replaceAll('-', ''));
                const payload = categoryID << BigInt(31) | BigInt(2 << 27) | pin;
                const setupURI = `X-HM://${payload.toString(36).toUpperCase().padStart(9, '0')}${data.setup_id}`;

                div.innerHTML += `<pre>Setup Name: ${data.name}
Setup Code: ${data.setup_code}</pre>
<div id="homekit-qrcode"></div>`;

                /* global QRCode */
                new QRCode('homekit-qrcode', {text: setupURI, width: 128, height: 128});
            };
            document.head.appendChild(script);
        });
    </script>

    <div>
        <h2>Play audio</h2>
        <label><input type="radio" name="play" value="file" checked>
            file - play remote (https://example.com/song.mp3) or local (/media/song.mp3) file
        </label>
        <label><input type="radio" name="play" value="live">
            live - play remote live stream (radio, etc.)
        </label>
        <label><input type="radio" name="play" value="text">
            text - play Text To Speech (if your FFmpeg support this)
        </label>
        <br>
        <input id="play-url" type="text" placeholder="path / url / text">
        <button id="play-send">send</button>
        / cameras with two way audio support
    </div>
    <script>
        document.getElementById('play-send').addEventListener('click', ev => {
            ev.preventDefault();
            // action - file / live / text
            const action = document.querySelector('input[name="play"]:checked').value;
            const url = new URL('api/ffmpeg', location.href);
            url.searchParams.set('dst', src);
            url.searchParams.set(action, document.getElementById('play-url').value);
            fetch(url, {method: 'POST'});
        });
    </script>

    <div>
        <h2>Publish stream</h2>
        <pre>YouTube:  rtmps://xxx.rtmp.youtube.com/live2/xxxx-xxxx-xxxx-xxxx-xxxx
Telegram: rtmps://xxx-x.rtmp.t.me/s/xxxxxxxxxx:xxxxxxxxxxxxxxxxxxxxxx</pre>
        <input id="pub-url" type="text" placeholder="url">
        <button id="pub-send">send</button>
        / Telegram RTMPS server
    </div>
    <script>
        document.getElementById('pub-send').addEventListener('click', ev => {
            ev.preventDefault();
            const url = new URL('api/streams', location.href);
            url.searchParams.set('src', src);
            url.searchParams.set('dst', document.getElementById('pub-url').value);
            fetch(url, {method: 'POST'});
        });
    </script>
    <script>
        const applyReadOnly = () => {
            const ids = ['play-send', 'play-url', 'pub-send', 'pub-url'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.disabled = true;
            });
        };

        if (window.go2rtcReady) {
            window.go2rtcReady.then(data => {
                if (data && data.read_only) applyReadOnly();
            });
        }
    </script>

    <div id="webrtc">
        <h2>WebRTC Magic</h2>
        <label><input type="radio" name="webrtc" value="video+audio" checked>
            video+audio = simple viewer
        </label>
        <label><input type="radio" name="webrtc" value="video+audio+microphone">
            video+audio+microphone = two way audio from camera
        </label>
        <label><input type="radio" name="webrtc" value="camera+microphone">
            camera+microphone = stream from browser
        </label>
        <label><input type="radio" name="webrtc" value="display+speaker">
            display+speaker = broadcast software
        </label>

        <br>
        <li><a id="local" href="webrtc.html?src=">webrtc.html</a> local WebRTC viewer</li>

        <li>
            <a id="shareadd" href="#">share link</a>
            <a id="shareget" href="#">copy link</a>
            <a id="sharedel" href="#">delete</a>
            external WebRTC viewer
        </li>
    </div>
    <script>
        function webrtcLinksUpdate() {
            const media = document.querySelector('input[name="webrtc"]:checked').value;

            const direction = media.indexOf('video') >= 0 || media === 'audio' ? 'src' : 'dst';
            document.getElementById('local').href = `webrtc.html?${direction}=${src}&media=${media}`;

            const share = document.getElementById('shareget');
            share.href = `https://go2rtc.org/webtorrent/#${share.dataset.auth}&media=${media}`;
        }

        function share(method) {
            const url = new URL('api/webtorrent', location.href);
            url.searchParams.set('src', src);
            return fetch(url, {method: method, cache: 'no-cache'});
        }

        function onshareadd(r) {
            document.getElementById('shareget').dataset['auth'] = `share=${r.share}&pwd=${r.pwd}`;

            document.getElementById('shareadd').style.display = 'none';
            document.getElementById('shareget').style.display = '';
            document.getElementById('sharedel').style.display = '';

            webrtcLinksUpdate();
        }

        function onsharedel() {
            document.getElementById('shareadd').style.display = '';
            document.getElementById('shareget').style.display = 'none';
            document.getElementById('sharedel').style.display = 'none';
        }

        function copyTextToClipboard(text) {
            // https://web.dev/patterns/clipboard/copy-text
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).catch(err => {
                    console.error(err.name, err.message);
                });
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);

                textarea.focus();
                textarea.select();

                try {
                    document.execCommand('copy');
                } catch (err) {
                    console.error(err.name, err.message);
                }

                document.body.removeChild(textarea);
            }
        }

        document.getElementById('shareadd').addEventListener('click', ev => {
            ev.preventDefault();
            share('POST').then(r => r.json()).then(r => onshareadd(r));
        });

        document.getElementById('shareget').addEventListener('click', ev => {
            ev.preventDefault();
            copyTextToClipboard(ev.target.href);
        });

        document.getElementById('sharedel').addEventListener('click', ev => {
            ev.preventDefault();
            share('DELETE').then(() => onsharedel());
        });

        document.getElementById('webrtc').addEventListener('click', ev => {
            if (ev.target.tagName === 'INPUT') webrtcLinksUpdate();
        });

        share('GET').then(r => {
            if (r.ok) r.json().then(r => onshareadd(r));
            else onsharedel();
        });

        webrtcLinksUpdate();
    </script>
</main>

</body>
</html>
